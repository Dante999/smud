<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
    "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head><title>harryPotter map</title>
        <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7"/>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8">
        <!--<title></title>-->
        <style>
            
        </style>
	<script type="text/javascript" src="http://maps.gaardian.com/wz_jsgraphics.js"></script>
    </head>
<style>
/* @override http://maps.gaardian.com/maps.css */

.top-strip {
	position: absolute;
	left: 0px;
	top: 0px;
	width: 100%;
	background-color: #d6ffdb;
	color: black;
	/*height: 180px;*/
        height: 100px;
}

.top-strip a {
	text-decoration: none;
}

.top-strip a.main-site {
	color: black;
}

.header, .areainfo {
	font-size: 18pt;
	position: absolute;
	top: 40px;
	left: 100px;
	font-family: Tahoma;
	text-align: right;
}

.areaname {
	font-size: 10pt;
}

.areainfo {
	font-size: 10pt;
	top: 95px;
	height: 70px;
	text-align: left;
	background-color: #d6ffdb;
	z-index: 1;
	border-left: 5px ridge #709975;
	padding-left: 10px;
}

body {
	font-family: Verdana, Tahoma;
	font-size: 10pt;
}

.map-container {
	position: absolute;
	top: 255px;
	left: 0px;
	padding-left: 15px;
	width: 95%;
}

.area-listing {
	position: absolute;
	top: 210px;
	left: 100px;
	width: 71%;
}

.warning {
	position: absolute;
	top: 210px;
	left: 100px;
	padding-top: 10px;
	padding-bottom: 10px;
	color: red;
	text-align: center;
}

.searchbox {
	font-size: 12pt;
	position: absolute;
	top: 50px;
	left: 500px;
	font-family: Tahoma;
	text-align: left;
}

.searchbox button, .searchbox input {
	font-size: 10pt;
}

.searchbox-results {
	font-size: 10pt;
}

.hits {
	font-size: 7pt;
	color: gray;
	font-style: italic;
}

.message {
	position: absolute;
	top: 200px;
	left: 100px;
	border: dotted 1px;
	padding: 5px;
	text-align: center;
}

li {
	padding-bottom: 5px;
}

ul {
	padding-top: 5px;
}

a {
	color: #54785b;
}

a:hover, .top-strip a.main-site:hover {
	color: #c890c3;
}

.letter {
  vertical-align: top;
  font-size: 14pt;
  padding-top: 20px;
  font-family: Verdana;
}
</style>
    <!-- 
    COPYRIGHT INFORMATION.
    
    The Mid'Gaardian Publishing Group encourages a community of sharing, 
    so the Gaardian Map Archives code is copyleft, with some restrictions: 
    you are free to reproduce, adapt to your own purposes, or otherwise 
    distribute the source code behind the Gaardian Map Archives as long as 
    any resulting copies or adapted versions are also bounded by the same 
    copyleft licensing scheme. 
    
    As a common courtesy to your fellow mappers, you are required to give 
    credit to any maps themselves (as opposed to the source code) 
    that you did not create.
    
    This license in its entirety can be seen at http://maps.gaardian.com
    -->
    <body id="" onload="">
        <!--<div class="top-strip" id="top-strip">
            <div class="header"><a class="main-site" href="http://gaardian.com">The Gaardian</a> <a href="http://maps.gaardian.com">Map Archives</a></div>
        </div>-->
<div class="top-strip" id="top-strip"><div class="header">harryPotter</div>Map code by <a href="http://maps.gaardian.com/">Gaardian.com</a>, map generated by <a href="https://github.com/Neop/mudmap2">MUD Map 2</a></div><div id="map-container" class="map-container">
<script type="text/javascript">
// From http://jennifermadden.com/javascript/stringEnterKeyDetector.html
function checkForEnter(e){ //e is event object passed from function invocation
    var characterCode; // literal character code will be stored in this variable

    if (e && e.which) { //if which property of event object is supported (NN4)
        e = e;
        characterCode = e.which; //character code is contained in NN4's which property
    }
    else {
        e = event;
        characterCode = e.keyCode; //character code is contained in IE's keyCode property
    }

    if(characterCode == 13){ //if generated character code is equal to ascii 13 (if enter key)
        submitSearchRoomsRequest();
    }
    return false;
}

function Room(roomid, roomname, xpos, ypos, isEntrance, aggroType, graffiti, pk, roomcolor, exitsArray) {
    this.roomid = roomid;
    this.roomname = roomname;
    this.xpos = xpos;
    this.ypos = ypos;
    this.isEntrance = isEntrance;
    this.aggroType = aggroType;
    this.graffiti = graffiti;
    this.pk = pk;
    this.roomcolor = roomcolor;
    this.exitsArray = exitsArray;
}
function RoomExit(room1, room2, linktype, exittype, exitaction, random, areaexit, doorinfo, forceBrokenExit) {
    this.room1 = room1;
    this.room2 = room2;
    this.linktype = linktype;
    this.exittype = exittype;
    this.exitaction = exitaction;
    this.random = random;
    this.areaexit = areaexit; // instance of RoomAreaExitInfo
    this.doorinfo = doorinfo;
    /* whether to render the exit as broken - currently only valid for up/down exits
     * ideally, this wouldn't be necessary, but there are too many tricky cases 
     * not covered by the slope-room detection algorithm */
    this.forceBrokenExit = forceBrokenExit;
}
function RoomAreaExitInfo(areaid, areaname) {
    this.areaid = areaid;
    this.areaname = areaname;
}
function DoorInfo(doorname, doortype, keyname, keydesc, keyroom) {
    this.doorname = doorname;
    this.doortype = doortype;
    this.keyname = keyname;
    this.keydesc = keydesc;
    this.keyroom = keyroom;
}
function MapLabel(xpos, ypos, width, text, color, type) {
    this.xpos = xpos;
    this.ypos = ypos;
    this.width = width;
    this.labeltext = text;
    this.labelcolor = color;
    this.labeltype = type;
}

var LINK_ONEWAY = 0;
var LINK_TWOWAY = 1;
var LINK_DISCONNECTED = 2;
var LINK_TO_ANOTHER_AREA = 3;

var MAX_SLOPE = 6;

var CONTAINER_HEIGHT = 255; // should map to #map-container's top pos
var CONTAINER_PAD_LEFT = 0; // how much to shift #map-container to the right; by default, this is none
var CONTAINER_PAD_RIGHT = 0; // how much to expand the #map-container and #top-strip; by default, this is none
var CONTAINER_PAD_DOWN = 0; // how much to push the #map-container down; by default, this is none

// section labels are bold, centered and 14pt
var LABEL_TYPE_SECTION_CENTER = 1;
var LABEL_TYPE_SECTION_TOP = 2;
var LABEL_TYPE_SECTION_BOTTOM = 3;

// jumbo-sized labels (bold, italicized, centered, 24pt)
var LABEL_TYPE_SECTION_JUMBO_CENTER = 11;

// plain text, left-justified, 10pt
var LABEL_TYPE_INFORMATIONAL = 21;

var EXIT_NORTH = 0;
var EXIT_EAST = 1;
var EXIT_SOUTH = 2;
var EXIT_WEST = 3;
var EXIT_UP = 4;
var EXIT_DOWN = 5;

var DOOR_CLOSED = 1;
var DOOR_LOCKED = 2;

var CUSTOMEXITFONT = "Verdana";
var NORMALROOMFONT = "Tahoma";

var rooms = new Array();
var fill_grid = new Array(); // indicates whether the space in the grid is filled by a room or not
var labels = new Array();

rooms[1] = new Room(1, "Winkelgassenstraße 7", 3, 5, false, 0, false, false, '#808080', null);
rooms[2] = new Room(2, "Scribbulus' Schreibwaren ", 4, 8, false, 0, false, false, '', null);
rooms[3] = new Room(3, "Wiseacres Zauberausrüstung ", 2, 8, false, 0, false, false, '', null);
rooms[4] = new Room(4, "Winkelgassenstraße 88", 2, 13, false, 0, false, false, '#808080', null);
rooms[5] = new Room(5, "Gringotts", 2, 3, false, 0, false, false, '', null);
rooms[6] = new Room(6, "Sugarplums Süßwarenladen ", 1, 12, false, 0, false, false, '', null);
rooms[7] = new Room(7, "Gringotts", 2, 2, false, 0, false, false, '', null);
rooms[8] = new Room(8, "Borgin & Burke's", 6, 5, false, 0, false, false, '', null);
rooms[9] = new Room(9, "Potages Kesselladen", 2, 11, false, 0, false, false, '', null);
rooms[10] = new Room(10, "Winkelgassenstraße 5", 3, 7, false, 0, false, false, '#808080', null);
rooms[11] = new Room(11, "Gringotts", 4, 1, false, 0, false, false, '', null);
rooms[12] = new Room(12, "Winkelgassenstraße 98", 4, 13, false, 0, false, false, '#808080', null);
rooms[13] = new Room(13, "Gringotts", 3, 1, false, 0, false, false, '', null);
rooms[14] = new Room(14, "Nokturngassenstraße 1", 4, 4, false, 0, false, false, '#808080', null);
rooms[15] = new Room(15, "Second-Hand Bookshop", 4, 11, false, 0, false, false, '', null);
rooms[16] = new Room(16, "Winkelgassenstraße 1", 3, 11, false, 0, false, false, '#808080', null);
rooms[17] = new Room(17, "Gringotts", 3, 2, false, 0, false, false, '', null);
rooms[18] = new Room(18, "Madam Malkins - Anzüge für alle Gelegenheiten", 2, 10, false, 0, false, false, '', null);
rooms[19] = new Room(19, "Winkelgassenstraße 2", 3, 10, false, 0, false, false, '#808080', null);
rooms[20] = new Room(20, "Winkelgassenstraße 6", 3, 6, false, 0, false, false, '#808080', null);
rooms[21] = new Room(21, "Gringotts", 4, 2, false, 0, false, false, '', null);
rooms[22] = new Room(22, "Gringotts", 3, 3, false, 0, false, false, '', null);
rooms[23] = new Room(23, "Flourish und Blotts' Zauberbuchhandlung ", 4, 7, false, 0, false, false, '', null);
rooms[24] = new Room(24, "Cranville Quinceys magischer Kramladen ", 1, 13, false, 0, false, false, '', null);
rooms[25] = new Room(25, "Mr Mulpeppers Apotheke ", 2, 7, false, 0, false, false, '', null);
rooms[26] = new Room(26, "Eeylops Eulenkaufhaus", 2, 9, false, 0, false, false, '', null);
rooms[27] = new Room(27, "Qualität für Quidditch", 4, 9, false, 0, false, false, '', null);
rooms[28] = new Room(28, "Gringotts", 3, 4, false, 0, false, false, '', null);
rooms[29] = new Room(29, "Ollivanders' Zauberstäbe", 4, 6, false, 0, false, false, '', null);
rooms[30] = new Room(30, "Winkelgassenstraße 89", 2, 12, false, 0, false, false, '#808080', null);
rooms[31] = new Room(31, "Winkelgassenstraße 99", 4, 12, false, 0, false, false, '#808080', null);
rooms[32] = new Room(32, "Freud und Leid's Laden für Zauberscherze", 5, 12, false, 0, false, false, '', null);
rooms[33] = new Room(33, "Gringotts", 4, 3, false, 0, false, false, '', null);
rooms[34] = new Room(34, "Winkelgassenstraße 3", 3, 9, false, 0, false, false, '#808080', null);
rooms[35] = new Room(35, "Florean Fortescues Eissalon", 4, 10, false, 0, false, false, '', null);
rooms[36] = new Room(36, "Slug & Jiggers Apotheke ", 2, 6, false, 0, false, false, '', null);
rooms[37] = new Room(37, "Nokturngassenstraße 2", 5, 4, false, 0, false, false, '#808080', null);
rooms[38] = new Room(38, "Der Tropfende Kessel", 3, 12, false, 0, false, false, '', null);
rooms[39] = new Room(39, "Winkelgassenstraße 4", 3, 8, false, 0, false, false, '#808080', null);
rooms[40] = new Room(40, "Broomstix Besenladen ", 4, 5, false, 0, false, false, '', null);
rooms[41] = new Room(41, "Gringotts", 2, 1, false, 0, false, false, '', null);
rooms[42] = new Room(42, "leeres Haus", 5, 13, false, 0, false, false, '', null);
rooms[43] = new Room(43, "Magische Menagerie", 2, 5, false, 0, false, false, '', null);
rooms[44] = new Room(44, "Nokturngassenstraße 3", 6, 4, false, 0, false, false, '#808080', null);

rooms[1].exitsArray = [new RoomExit(rooms[1], rooms[20], LINK_ONEWAY, 2, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[1], rooms[14], LINK_ONEWAY, 4, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[1], rooms[43], LINK_ONEWAY, 3, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[1], rooms[40], LINK_ONEWAY, 1, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[1], rooms[28], LINK_ONEWAY, 0, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[2].exitsArray = [new RoomExit(rooms[2], rooms[39], LINK_ONEWAY, 3, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[3].exitsArray = [new RoomExit(rooms[3], rooms[39], LINK_ONEWAY, 1, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[4].exitsArray = [new RoomExit(rooms[4], rooms[30], LINK_ONEWAY, 0, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[4], rooms[24], LINK_ONEWAY, 3, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[5].exitsArray = [new RoomExit(rooms[5], rooms[22], LINK_ONEWAY, 1, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[5], rooms[7], LINK_ONEWAY, 0, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[6].exitsArray = [new RoomExit(rooms[6], rooms[30], LINK_ONEWAY, 1, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[7].exitsArray = [new RoomExit(rooms[7], rooms[17], LINK_ONEWAY, 1, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[7], rooms[5], LINK_ONEWAY, 2, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[7], rooms[41], LINK_ONEWAY, 0, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[8].exitsArray = [new RoomExit(rooms[8], rooms[44], LINK_ONEWAY, 0, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[9].exitsArray = [new RoomExit(rooms[9], rooms[16], LINK_ONEWAY, 1, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[10].exitsArray = [new RoomExit(rooms[10], rooms[20], LINK_ONEWAY, 0, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[10], rooms[25], LINK_ONEWAY, 3, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[10], rooms[23], LINK_ONEWAY, 1, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[10], rooms[39], LINK_ONEWAY, 2, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[11].exitsArray = [new RoomExit(rooms[11], rooms[21], LINK_ONEWAY, 2, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[11], rooms[13], LINK_ONEWAY, 3, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[12].exitsArray = [new RoomExit(rooms[12], rooms[42], LINK_ONEWAY, 1, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[12], rooms[31], LINK_ONEWAY, 0, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[13].exitsArray = [new RoomExit(rooms[13], rooms[17], LINK_ONEWAY, 2, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[13], rooms[11], LINK_ONEWAY, 1, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[13], rooms[41], LINK_ONEWAY, 3, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[14].exitsArray = [new RoomExit(rooms[14], rooms[37], LINK_ONEWAY, 1, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[14], rooms[1], LINK_ONEWAY, 5, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[15].exitsArray = [new RoomExit(rooms[15], rooms[16], LINK_ONEWAY, 3, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[16].exitsArray = [new RoomExit(rooms[16], rooms[38], LINK_ONEWAY, 2, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[16], rooms[9], LINK_ONEWAY, 3, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[16], rooms[30], LINK_ONEWAY, 5, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[16], rooms[15], LINK_ONEWAY, 1, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[16], rooms[19], LINK_ONEWAY, 0, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[16], rooms[31], LINK_ONEWAY, 5, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[17].exitsArray = [new RoomExit(rooms[17], rooms[7], LINK_ONEWAY, 3, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[17], rooms[13], LINK_ONEWAY, 0, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[17], rooms[21], LINK_ONEWAY, 1, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[17], rooms[22], LINK_ONEWAY, 2, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[18].exitsArray = [new RoomExit(rooms[18], rooms[19], LINK_ONEWAY, 1, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[19].exitsArray = [new RoomExit(rooms[19], rooms[35], LINK_ONEWAY, 1, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[19], rooms[16], LINK_ONEWAY, 2, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[19], rooms[34], LINK_ONEWAY, 0, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[19], rooms[18], LINK_ONEWAY, 3, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[20].exitsArray = [new RoomExit(rooms[20], rooms[1], LINK_ONEWAY, 0, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[20], rooms[10], LINK_ONEWAY, 2, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[20], rooms[36], LINK_ONEWAY, 3, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[20], rooms[29], LINK_ONEWAY, 1, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[21].exitsArray = [new RoomExit(rooms[21], rooms[11], LINK_ONEWAY, 0, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[21], rooms[33], LINK_ONEWAY, 2, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[21], rooms[17], LINK_ONEWAY, 3, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[22].exitsArray = [new RoomExit(rooms[22], rooms[5], LINK_ONEWAY, 3, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[22], rooms[33], LINK_ONEWAY, 1, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[22], rooms[28], LINK_ONEWAY, 2, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[22], rooms[17], LINK_ONEWAY, 0, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[23].exitsArray = [new RoomExit(rooms[23], rooms[10], LINK_ONEWAY, 3, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[24].exitsArray = [new RoomExit(rooms[24], rooms[4], LINK_ONEWAY, 1, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[25].exitsArray = [new RoomExit(rooms[25], rooms[10], LINK_ONEWAY, 1, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[26].exitsArray = [new RoomExit(rooms[26], rooms[34], LINK_ONEWAY, 1, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[27].exitsArray = [new RoomExit(rooms[27], rooms[34], LINK_ONEWAY, 3, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[28].exitsArray = [new RoomExit(rooms[28], rooms[22], LINK_ONEWAY, 0, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[28], rooms[1], LINK_ONEWAY, 2, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[29].exitsArray = [new RoomExit(rooms[29], rooms[20], LINK_ONEWAY, 3, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[30].exitsArray = [new RoomExit(rooms[30], rooms[16], LINK_ONEWAY, 4, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[30], rooms[4], LINK_ONEWAY, 2, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[30], rooms[6], LINK_ONEWAY, 3, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[31].exitsArray = [new RoomExit(rooms[31], rooms[32], LINK_ONEWAY, 1, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[31], rooms[16], LINK_ONEWAY, 4, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[31], rooms[12], LINK_ONEWAY, 2, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[32].exitsArray = [new RoomExit(rooms[32], rooms[31], LINK_ONEWAY, 3, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[33].exitsArray = [new RoomExit(rooms[33], rooms[21], LINK_ONEWAY, 0, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[33], rooms[22], LINK_ONEWAY, 3, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[34].exitsArray = [new RoomExit(rooms[34], rooms[27], LINK_ONEWAY, 1, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[34], rooms[39], LINK_ONEWAY, 0, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[34], rooms[26], LINK_ONEWAY, 3, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[34], rooms[19], LINK_ONEWAY, 2, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[35].exitsArray = [new RoomExit(rooms[35], rooms[19], LINK_ONEWAY, 3, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[36].exitsArray = [new RoomExit(rooms[36], rooms[20], LINK_ONEWAY, 1, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[37].exitsArray = [new RoomExit(rooms[37], rooms[14], LINK_ONEWAY, 3, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[37], rooms[44], LINK_ONEWAY, 1, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[38].exitsArray = [new RoomExit(rooms[38], rooms[16], LINK_ONEWAY, 0, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[39].exitsArray = [new RoomExit(rooms[39], rooms[34], LINK_ONEWAY, 2, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[39], rooms[10], LINK_ONEWAY, 0, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[39], rooms[3], LINK_ONEWAY, 3, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[39], rooms[2], LINK_ONEWAY, 1, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[40].exitsArray = [new RoomExit(rooms[40], rooms[1], LINK_ONEWAY, 3, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[41].exitsArray = [new RoomExit(rooms[41], rooms[13], LINK_ONEWAY, 1, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[41], rooms[7], LINK_ONEWAY, 2, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[42].exitsArray = [new RoomExit(rooms[42], rooms[12], LINK_ONEWAY, 3, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[43].exitsArray = [new RoomExit(rooms[43], rooms[1], LINK_ONEWAY, 1, "", false, null, new DoorInfo("", 0 , "", "", null)),]
rooms[44].exitsArray = [new RoomExit(rooms[44], rooms[8], LINK_ONEWAY, 2, "", false, null, new DoorInfo("", 0 , "", "", null)),new RoomExit(rooms[44], rooms[37], LINK_ONEWAY, 3, "", false, null, new DoorInfo("", 0 , "", "", null)),]

var gridmaxx = 6, gridmaxy = 13;

</script>
        </div>
<script type="text/javascript">
function getOppositeExitType(exittype) {
    switch (exittype) {
		case 0:
			return 2;
		case 1:
			return 3;
		case 2:
			return 0;
		case 3:
			return 1;
		case 4:
			return 5;
		case 5:
		    return 4;
	}
	return exittype;
}

var room_height = 60, room_width = 100;
var roomgap_x = 50, roomgap_y = 40;
var door_width = room_height / 2;
var arrowheadlength = roomgap_x / 6;
var brokenexit_x = roomgap_x / 3;
var brokenexit_y = roomgap_y / 2;
var highlightedRooms = '';
var highlightedKeyRoom = '';
var renderedAreaExits = new Array();


function init() {
    var entranceroom = null;
    var padContainerLeft = false;
    var padContainerRight = false;
    var padContainerDown = false;
    // Calculate all twoway indices and find the entrance room.
    for (var i = 1, roomsLength = rooms.length; i < roomsLength; i++) {
        exits = rooms[i].exitsArray;
        if (exits != null) {
            for (var j = 0, exitsLength = exits.length; j < exitsLength; j++) {
                var roomexit = exits[j];
                var exittype = roomexit.exittype;
                if (roomexit.areaexit != null) {
                    // area exits have special renderers
                    roomexit.linktype = LINK_TO_ANOTHER_AREA;
                    if (roomexit.room1.xpos == 1 && (roomexit.exittype == EXIT_WEST || roomexit.exittype == EXIT_DOWN)) {
                        padContainerLeft = true;
                    } else if (roomexit.room1.xpos == gridmaxx && (roomexit.exittype == EXIT_EAST || roomexit.exittype == EXIT_UP)) {
                        padContainerRight = true;
                    }
                    if (roomexit.room1.ypos == gridmaxy && (roomexit.exittype == EXIT_SOUTH || roomexit.exittype == EXIT_DOWN)) {
                        padContainerDown = true;
                    }
                } else if (exittype > 5) {
                    // portals or special exits are disconnected
                    roomexit.linktype = LINK_DISCONNECTED;
                } else {
                    var oppositeExittype = getOppositeExitType(exittype);
                    targetexits = roomexit.room2.exitsArray;
                    for (var k = 0, targetexitsLength = targetexits.length; k < targetexitsLength; k++) {
                        if (targetexits[k].areaexit == null && targetexits[k].room2.roomid == roomexit.room1.roomid && targetexits[k].exittype == oppositeExittype) {
                            roomexit.linktype = LINK_TWOWAY;
                            break;
                        }
                    }
                }
            }
        }
        if (rooms[i].isEntrance) {
            entranceroom = rooms[i];
        }
    }
    
    // Pad left for area exits if necessary
    if (padContainerLeft) {
        CONTAINER_PAD_LEFT = room_width;
        var container = document.getElementById("map-container");
        container.style.left = CONTAINER_PAD_LEFT + "px";
    }
    if (padContainerRight) {
        CONTAINER_PAD_RIGHT = room_width;
    }
    if (padContainerDown) {
        CONTAINER_PAD_DOWN = room_height;
    }
    
	// Ready for drawing now!
}
init();

var jg = new jsGraphics("map-container");
var jg3 = new jsGraphics("map-container");
// order is important
var jg4 = new jsGraphics("map-container");
var jg2 = new jsGraphics("map-container");

function drawLabel(label, jg) {
    var x = calcLeftPos(label);
    var y = calcTopPos(label);
    // we don't need height
    var width = label.width * room_width + (label.width - 1) * roomgap_x;
    var alignment = "center";
    var fontsize = "10pt";
    var fontfamily = NORMALROOMFONT;
    var fontweight = Font.PLAIN;
    var lineheight = null;
    switch (label.labeltype) {
        case LABEL_TYPE_SECTION_CENTER: case LABEL_TYPE_SECTION_BOTTOM: case LABEL_TYPE_SECTION_TOP:
            alignment = "center";
            fontsize = "14pt";
            fontweight = Font.BOLD;
            break;
        case LABEL_TYPE_SECTION_JUMBO_CENTER:
            alignment = "center";
            fontsize = "24pt";
            fontweight = Font.ITALIC_BOLD;
            break;
        case LABEL_TYPE_INFORMATIONAL:
            alignment = "left";
            fontsize = "10pt";
            fontweight = Font.PLAIN;
            break;
    }
    switch (label.labeltype) {
        case LABEL_TYPE_SECTION_CENTER: case LABEL_TYPE_SECTION_JUMBO_CENTER:
            lineheight = room_height;
            break;
    }
    jg.setFont(fontfamily, fontsize, fontweight); 
    jg.setColor(label.labelcolor);
    jg.drawStringRect(label.labeltext, x, y, width, alignment, lineheight);
}

function drawRoom(room, jg, borderColor, backgroundColor) {
    x = calcLeftPos(room);
    y = calcTopPos(room);
    if (backgroundColor == null && room.roomcolor != "") {
        backgroundColor = room.roomcolor;
    }
    if (backgroundColor != null) {
        jg.setStroke(1);
        jg.setColor(backgroundColor);
        jg.fillRect(x, y, room_width, room_height);
    }
    if (borderColor != null) {
        jg.setColor(borderColor);
        jg.setStroke(5);
    } else {
        if (room.isEntrance) {
            jg.setColor("green");
            jg.setStroke(5);
        } else if (room.aggroType > 0) {
            if (room.aggroType == 1) {
                // moving aggressive (this section of the area contains aggressives)
                jg.setStroke(2);
            } else {
                // stationary aggressive
                jg.setStroke(4);
            }
            jg.setColor("red");
        } else {
            jg.setColor("black");
            jg.setStroke(2);
        }
    }
    jg.drawRect(x, y, room_width, room_height);
    if (room.pk) {
        jg.setColor("red");
        jg.setFont(NORMALROOMFONT,"10px",Font.BOLD);
        jg.drawStringRect("PK", x + 5, calcBottomPos(room) - 15, 15, "left");
    }
    jg.setColor("black");
    var fontsize = "12px";
    // todo: make it check the height of the new div and size appropriately
    if (getFormattedRoomname(room).length >= 39) {
        fontsize = "10px";
    }
    jg.setFont(NORMALROOMFONT,fontsize,Font.PLAIN);
    jg.drawStringRect(getFormattedRoomname(room), x + 4, y + 5, room_width - 5, "center");
    
    // finally, re-render the first disconnected exit if it has been obscured
    if (backgroundColor != null) {
        rerenderFirstDisconnectedExit(room, jg);
    }
}

function getFormattedRoomname(room) {
    var roomname = room.roomname;
    if (room.graffiti) {
        roomname += " (G)";
    }
    return roomname;
}

function isExitDirectlyConnected(exittype, room1, room2) {
    if (exittype == EXIT_EAST) {
        if (room1.xpos > room2.xpos) {
            return false;
        }
        for (var i = room1.xpos + 1; i < room2.xpos && i <= gridmaxx; i++) {
            if (fill_grid[i][room1.ypos]) {
                return false;
            }
        }
        return true;
    } else if (exittype == EXIT_WEST) {
        if (room2.xpos > room1.xpos) {
            return false;
        }
        for (var i = room2.xpos + 1; i < room1.xpos && i <= gridmaxx; i++) {
            if (fill_grid[i][room2.ypos]) {
                return false;
            }
        }
        return true;
    } else if (exittype == EXIT_SOUTH) {
        if (room1.ypos > room2.ypos) {
            return false;
        }
        for (var i = room1.ypos + 1; i < room2.ypos && i <= gridmaxy; i++) {
            if (fill_grid[room1.xpos][i]) {
                return false;
            }
        }
        return true;
    } else if (exittype == EXIT_NORTH) {
        if (room2.ypos > room1.ypos) {
            return false;
        }
        for (var i = room2.ypos + 1; i < room1.ypos && i <= gridmaxy; i++) {
            if (fill_grid[room2.xpos][i]) {
                return false;
            }
        }
        return true;
    } else if (exittype == EXIT_UP) {
        // room1 can have two up exits - top left up or top right up
        if (room2.ypos >= room1.ypos) {
            return false;
        }
        // can't be directly on top of each other!
        if (room1.xpos == room2.xpos) {
            return false;
        }
        var rise = room1.ypos - room2.ypos;
        var run = room1.xpos - room2.xpos;
        var m = rise / run;
        if (Math.abs(m) == 1) { 
            // for each of these exits, see if a room lies in the path
            if (room1.xpos < room2.xpos) {
                // top right up
                var x = room1.xpos + 1;
                for (var i = room1.ypos - 1; i > room2.ypos && i >= 1; i--) {
                    if (fill_grid[x][i]) {
                        return false;
                    }
                    x++;
                }
            } else if (room1.xpos > room2.xpos) {
                // top left up
                var x = room1.xpos - 1;
                for (var i = room1.ypos - 1; i > room2.ypos && i >= 1; i--) {
                    if (fill_grid[x][i]) {
                        return false;
                    }
                    x--;
                }
            }
        } else {
            // not a straight slope; determine if there are rooms occupied within
            // 1 gridroom of this line
            // calculate b in y = mx + b
            var b = room1.ypos - (m * room1.xpos);
            // make sure the slope isn't too steep for rooms next to each other
            if (Math.abs(run) == 1 && Math.abs(m) >= MAX_SLOPE) {
                return false;
            }
            if (room1.xpos < room2.xpos) {
                // top right up
                var x = room1.xpos + 1;
                for (var y = m * x + b; y > room2.ypos && y >= 1; y = m * x + b) {
                    if (fill_grid[x][Math.ceil(y)]) {
                        return false;
                    }
                    x++;
                }
            } else if (room1.xpos > room2.xpos) {
                // top left up
                var x = room1.xpos - 1;
                for (var y = m * x + b; y > room2.ypos && y >= 1; y = m * x + b) {
                    if (fill_grid[x][Math.ceil(y)]) {
                        return false;
                    }
                    x--;
                }
            }
        }
        return true;
    } else if (exittype == EXIT_DOWN) {
        // room1 can have two up exits - bottom left down or bottom right down
        if (room1.ypos >= room2.ypos) {
            return false;
        }
        // can't be directly on top of each other!
        if (room1.xpos == room2.xpos) {
            return false;
        }
        var rise = room1.ypos - room2.ypos;
        var run = room1.xpos - room2.xpos;
        var m = rise / run;
        if (Math.abs(m) == 1) {
            // for each of these exits, see if a room lies in the path
            if (room1.xpos < room2.xpos) {
                // bottom right down
                var x = room1.xpos + 1;
                for (var i = room1.ypos + 1; i < room2.ypos && i <= gridmaxy; i++) {
                    if (fill_grid[x][i]) {
                        return false;
                    }
                    x++;
                }
            } else if (room1.xpos > room2.xpos) {
                // bottom left down
                var x = room1.xpos - 1;
                for (var i = room1.ypos + 1; i < room2.ypos && i <= gridmaxy; i++) {
                    if (fill_grid[x][i]) {
                        return false;
                    }
                    x--;
                }
            }
        } else {
            // not a straight slope; determine if there are rooms occupied within
            // 1 gridroom of this line
            // calculate b in y = mx + b
            var b = room1.ypos - (m * room1.xpos);
            // make sure the slope isn't too steep for rooms next to each other
            if (Math.abs(run) == 1 && Math.abs(m) >= MAX_SLOPE) {
                return false;
            }
            if (room1.xpos < room2.xpos) {
                // bottom right down
                var x = room1.xpos + 1;
                for (var y = m * x + b; y < room2.ypos && y <= gridmaxy; y = m * x + b) {
                    if (fill_grid[x][Math.ceil(y)]) {
                        return false;
                    }
                    x++;
                }
            } else if (room1.xpos > room2.xpos) {
                // bottom left down
                var x = room1.xpos - 1;
                for (var y = m * x + b; y < room2.ypos && y <= gridmaxy; y = m * x + b) {
                    if (fill_grid[x][Math.ceil(y)]) {
                        return false;
                    }
                    x--;
                }
            }
        }
        return true;
    }
    
}

function contains(a, obj){
  for(var i = 0; i < a.length; i++) {
    if(a[i] === obj){
      return true;
    }
  }
  return false;
}

function exitAlreadyRendered(roomexit, xpos, ypos) {
    var key = xpos + "," + ypos;
    var areaname = roomexit.areaexit.areaname;
    var renderedLocations = renderedAreaExits[areaname];
    if (renderedLocations != null) {
        if (contains(renderedLocations, key)) {
            return true;
        } else {
            renderedLocations.push(key);
            renderedAreaExits[areaname] = renderedLocations;
            return false;
        }
    } else {
        var renderedLocations = new Array();
        renderedLocations.push(key);
        renderedAreaExits[areaname] = renderedLocations;
        return false;
    }
}

// Top-left corner of grid is (0,0) -- actually, that should be (1,1) - (0,0) is used to denote an unmapped room
function drawExit(roomexit, jg) {
    jg.setStroke(2);
    var room1 = roomexit.room1;
    var room2 = roomexit.room2;
    var exittype = roomexit.exittype;
    if (roomexit.random) {
        jg.setColor("red");
    }
    // todo: refactor even further - call separate methods to draw exits for north/south, east/west, up/down, disconnected links
    if (roomexit.linktype == LINK_DISCONNECTED) {
        // draw the special exit command
        jg.setColor("blue");
        jg.setFont(CUSTOMEXITFONT,"10px",Font.PLAIN);
        var exitaction = roomexit.exitaction;
        if (roomexit.exittype == 6) {
            exitaction = "enter " + exitaction;
        }
        // calculate the position of this custom exit for this room
        var index = -1;
        var exitsArray = room1.exitsArray;
        for (var i = 0; i < exitsArray.length; i++) {
            if (exitsArray[i].linktype == LINK_DISCONNECTED) {
                index++;
            }
            if (exitsArray[i] == roomexit) {
                break;
            }
        }
        var delta = index * 16;
        if (room1.pk) {
            jg.drawStringRect(exitaction, calcLeftPos(room1) + 4, calcBottomPos(room1) - 14 + delta, room_width - 5, "right");
        } else {
            jg.drawStringRect(exitaction, calcLeftPos(room1) + 4, calcBottomPos(room1) - 14 + delta, room_width + 5, "left");
        }
        // draw the link connecting the rooms besides the exit string
        jg.drawImage('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAADpSURBVCjPY/jPgB8y0EmBHXdWaeu7ef9rHuaY50jU3J33v/VdVqkdN1SBEZtP18T/L/7f/X/wf+O96kM3f9z9f+T/xP8+XUZsYAWGfsUfrr6L2Ob9J/X/pP+V/1P/e/+J2LbiYfEHQz+ICV1N3yen+3PZf977/9z/Q//X/rf/7M81Ob3pu1EXWIFuZvr7aSVBOx1/uf0PBEK3/46/gnZOK0l/r5sJVqCp6Xu99/2qt+v+T/9f+L8CSK77v+pt73vf65qaYAVqzPYGXvdTvmR/z/4ZHhfunP0p+3vKF6/79gZqzPQLSYoUAABKPQ+kpVV/igAAAABJRU5ErkJggg%3D%3D',calcLeftPos(room1) - 16, calcBottomPos(room1) - 14 + delta, 16, 16, 'onclick="highlightRooms(rooms[' + room1.roomid + '], rooms[' + room2.roomid + ']);"');
    } else if (roomexit.linktype == LINK_TO_ANOTHER_AREA) {
        jg.setFont(NORMALROOMFONT,"12px",Font.ITALIC);
        if (exittype == EXIT_EAST) {
            var x1 = calcRightPos(room1);
            var y1 = calcMiddleYPos(room1);
            jg.drawLine(x1, y1, x1 + roomgap_x - 5, y1);
            if (!exitAlreadyRendered(roomexit, room1.xpos + 1, room1.ypos)) {
                jg.drawStringRect("To " + roomexit.areaexit.areaname, x1 + roomgap_x, calcTopPos(room1) + room_height / 4, room_width, "center");
            }
        } else if (exittype == EXIT_WEST) {
            var x1 = calcLeftPos(room1);
            var y1 = calcMiddleYPos(room1);
            jg.drawLine(x1, y1, x1 - roomgap_x + 5, y1);
            if (!exitAlreadyRendered(roomexit, room1.xpos - 1, room1.ypos)) {
                jg.drawStringRect("To " + roomexit.areaexit.areaname, x1 - roomgap_x - room_width, calcTopPos(room1) + room_height / 4, room_width, "center");
            }
        } else if (exittype == EXIT_SOUTH) {
            var x1 = calcMiddleXPos(room1);
            var y1 = calcBottomPos(room1);
            jg.drawLine(x1, y1, x1, y1 + roomgap_y - 5);
            if (!exitAlreadyRendered(roomexit, room1.xpos, room1.ypos + 1)) {
                jg.drawStringRect("To " + roomexit.areaexit.areaname, calcLeftPos(room1), y1 + roomgap_y, room_width, "center");
            }
        } else if (exittype == EXIT_NORTH) {
            var x1 = calcMiddleXPos(room1);
            var y1 = calcTopPos(room1);
            jg.drawLine(x1, y1, x1, y1 - roomgap_y + 5);
            if (!exitAlreadyRendered(roomexit, room1.xpos, room1.ypos - 1)) {
                jg.drawStringRect("To " + roomexit.areaexit.areaname, calcLeftPos(room1), y1 - roomgap_y - (room_height * 3 / 4), room_width, "center");
            }
        } else if (exittype == EXIT_UP) {
            // todo: special treatment for up exits where top-right is already filled (check fill_grid)
            var x1 = calcRightPos(room1);
            var y1 = calcTopPos(room1);
            jg.drawLine(x1, y1, x1 + roomgap_x, y1 - roomgap_y + 5);
            if (!exitAlreadyRendered(roomexit, room1.xpos + 1, room1.ypos - 1)) {
                jg.drawStringRect("To " + roomexit.areaexit.areaname, x1 + roomgap_x, y1 - roomgap_y - (room_height / 2), room_width, "center");
            }
        } else if (exittype == EXIT_DOWN) {
            // todo: special treatment for down exits where bottom-left is already filled (check fill_grid)
            var x1 = calcLeftPos(room1);
            var y1 = calcBottomPos(room1);
            jg.drawLine(x1, y1, x1 - roomgap_x, y1 + roomgap_y - 5);
            if (!exitAlreadyRendered(roomexit, room1.xpos - 1, room1.ypos + 1)) {
                jg.drawStringRect("To " + roomexit.areaexit.areaname, x1 - roomgap_x - room_width, y1 + roomgap_y, room_width, "center");
            }
        }
    } else {
        var room1x = room1.xpos;
        var room2x = room2.xpos;
        var room1y = room1.ypos;
        var room2y = room2.ypos;
        if (exittype == EXIT_EAST || exittype == EXIT_WEST) {
            if (room1 == room2) {
                // This exit loops back to itself
                if (exittype == EXIT_WEST) {
                    var x1 = calcLeftPos(room1);
                    var y1 = calcMiddleYPos(room1);
                    var midx = x1 - room_width / 4;
                    var midy = y1 - room_height / 4;
                    var xPoints = new Array(x1, midx, midx, x1);
                    var yPoints = new Array(y1, y1, midy, midy);
                    jg.drawPolyline(xPoints, yPoints);
                    // draw a one-way arrow
                    jg.drawLine(x1 - 1, midy, x1 - arrowheadlength, midy - arrowheadlength / 2);
                    jg.drawLine(x1 - 1, midy, x1 - arrowheadlength, midy + arrowheadlength / 2);
                } else if (exittype == EXIT_EAST) {
                    // todo: test this
                    var x1 = calcRightPos(room1);
                    var y1 = calcMiddleYPos(room1);
                    var midx = x1 + room_width / 4;
                    var midy = y1 + room_height / 4;
                    var xPoints = new Array(x1, midx, midx, x1);
                    var yPoints = new Array(y1, y1, midy, midy);
                    jg.drawPolyline(xPoints, yPoints);
                    // draw a one-way arrow
                    jg.drawLine(x1 + 1, midy, x1 + arrowheadlength, midy - arrowheadlength / 2);
                    jg.drawLine(x1 + 1, midy, x1 + arrowheadlength, midy + arrowheadlength / 2);
                }
            } else if (room1y == room2y && isExitDirectlyConnected(exittype, room1, room2)) {
                // East-west exit - assume no wraparound exits (e.g. if east exit of east room connects to west exit of west room)
                // This will be captured by isExitDirectlyConnected
                
                // assume east exit for now
                var x1 = calcRightPos(room1);
                var y1 = calcMiddleYPos(room1);
                var x2 = calcLeftPos(room2);
                var y2 = calcMiddleYPos(room2); // y1 should equal y2
                // change coordinates if this is a west exit
                if (room1x > room2x) {
                    x1 = calcLeftPos(room1);
                    y1 = calcMiddleYPos(room1);
                    x2 = calcRightPos(room2);
                    y2 = calcMiddleYPos(room2);
                }
                
                jg.drawLine(x1, y1, x2, y2);
                if (roomexit.doorinfo.doortype >= DOOR_CLOSED) {
                    var midx = x1 + (x2 - x1) / 2;
                    var topy = y1 - door_width / 2;
                    jg.drawLine(midx, topy, midx, y1 + door_width / 2);
                    // todo: clicking on locked doors should highlight room with key and show popup
                    if (roomexit.doorinfo.doortype == DOOR_LOCKED) {
                        jg.drawImage('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAJ/SURBVDjLbVJBaxNBGH2bpEkTmxi1NTRKTZtoQUHEWz0Igj2I4kG9eVNQhEBO7bEHc+yv8JAiHnr2B4gFqVrQRhObljQolBSTJqZJdnZmfbNr2rU68DEz33zfm/fejGHbNrxjaWlpRCk1J6WcYZxkgPGTsWJZ1mIul/vlrTe8AIVC4Qqbl5PJ5GQsFoPP5wP36PV6qNfr2OIg0L35+fm1fwDYPMLDj+l0OmOaJmq1Gjqdjr4dgUAAiUTCqSsWixvMXV5YWOjqvW+AxOSz8fHxjBAC5XJ5s91up7gO6tDrUqn0QwOTXYZSsoO+wGDB5EwkEkGlUgGb7mSz2apHajWfz9+sVqvFVCrl1P4PYExr5m16vYUjQ+c0O11DtmN/ebD95pG9UpnGzl7Y0Xz30ir8toAtLdiWG0JIvFi76piaGG7g9plVTD/5YLgMCPLg/g0YtMTwhznfApRBfsP6kAYJSKuN57Md5oXTsvHy7aEEfZMutHZfIRAahWGMsHAICMeZVsD+HmTrG8zudyhrH+HJLGyz7wEgRSh9k4nm+nvqPIb4xWuovV5k/2lMXJ9F8+s6ARqIpk6QsIQtTC+AcGTYpBqfvgBfcJTuKMi+xKfdMCZgIp6eRK8TYu2+w2oA4PwDm+5qVK218XmNLN7xxILqKfS7pGqTWekLmuVtV65STs8hA73RqJQQP5+CP3KKACamHj7FlGBDawfH00kEW0MuA8o9AmA6qMrSHqwTIAoM08hAkHkN0ES3UYfotBGdiNFu5cr2AmgJobOPET7nhxEMuU/o40soSjO7iHbbVNgnUen6pY0/AOCTbC7PuV44H0f8Cetg5g9zP5aU7loDcfwGcrKyzYdvwUUAAAAASUVORK5CYII%3D', midx + 4, topy - 4, 16, 16, generateOnClickHandlerForKey(roomexit.doorinfo, midx + 4, topy - 4));
                    }
                }
                // then draw uni-directional arrows, if applicable
                if (roomexit.linktype == LINK_ONEWAY) {
                    if (exittype == EXIT_EAST) {
                        // left to right
                        jg.drawLine(x2 - 1, y2, x2 - arrowheadlength, y2 - arrowheadlength / 2);
                        jg.drawLine(x2 - 1, y2, x2 - arrowheadlength, y2 + arrowheadlength / 2);
                    } else {
                        // right to left
                        jg.drawLine(x2 + 1, y2, x2 + arrowheadlength, y2 - arrowheadlength / 2);
                        jg.drawLine(x2 + 1, y2, x2 + arrowheadlength, y2 + arrowheadlength / 2);
                    }
                }
            } else {
                if (exittype == EXIT_EAST) {
                    var x1 = calcRightPos(room1);
                    var y1 = calcMiddleYPos(room1) - room_height / 4;
                    var x2 = x1 + brokenexit_x;
                    var y2 = y1;
                    jg.drawLine(x1, y1, x2, y2);
                    if (roomexit.doorinfo.doortype >= DOOR_CLOSED) {
                        var midx = x1 + (x2 - x1) / 2 - 2;
                        jg.drawLine(midx, y1 - door_width / 4, midx, y2 + door_width / 4);
                        if (roomexit.doorinfo.doortype == DOOR_LOCKED) {
                            jg.drawImage('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAJ/SURBVDjLbVJBaxNBGH2bpEkTmxi1NTRKTZtoQUHEWz0Igj2I4kG9eVNQhEBO7bEHc+yv8JAiHnr2B4gFqVrQRhObljQolBSTJqZJdnZmfbNr2rU68DEz33zfm/fejGHbNrxjaWlpRCk1J6WcYZxkgPGTsWJZ1mIul/vlrTe8AIVC4Qqbl5PJ5GQsFoPP5wP36PV6qNfr2OIg0L35+fm1fwDYPMLDj+l0OmOaJmq1Gjqdjr4dgUAAiUTCqSsWixvMXV5YWOjqvW+AxOSz8fHxjBAC5XJ5s91up7gO6tDrUqn0QwOTXYZSsoO+wGDB5EwkEkGlUgGb7mSz2apHajWfz9+sVqvFVCrl1P4PYExr5m16vYUjQ+c0O11DtmN/ebD95pG9UpnGzl7Y0Xz30ir8toAtLdiWG0JIvFi76piaGG7g9plVTD/5YLgMCPLg/g0YtMTwhznfApRBfsP6kAYJSKuN57Md5oXTsvHy7aEEfZMutHZfIRAahWGMsHAICMeZVsD+HmTrG8zudyhrH+HJLGyz7wEgRSh9k4nm+nvqPIb4xWuovV5k/2lMXJ9F8+s6ARqIpk6QsIQtTC+AcGTYpBqfvgBfcJTuKMi+xKfdMCZgIp6eRK8TYu2+w2oA4PwDm+5qVK218XmNLN7xxILqKfS7pGqTWekLmuVtV65STs8hA73RqJQQP5+CP3KKACamHj7FlGBDawfH00kEW0MuA8o9AmA6qMrSHqwTIAoM08hAkHkN0ES3UYfotBGdiNFu5cr2AmgJobOPET7nhxEMuU/o40soSjO7iHbbVNgnUen6pY0/AOCTbC7PuV44H0f8Cetg5g9zP5aU7loDcfwGcrKyzYdvwUUAAAAASUVORK5CYII%3D', midx + 4, y1 - 4, 16, 16, generateOnClickHandlerForKey(roomexit.doorinfo, midx + 4, y1 - 4));
                        }
                    }
                    if (roomexit.linktype == LINK_ONEWAY) {
                        jg.drawLine(x2 - 1, y2, x2 - arrowheadlength / 2, y2 - arrowheadlength / 2);
                        jg.drawLine(x2 - 1, y2, x2 - arrowheadlength / 2, y2 + arrowheadlength / 2);
                    }
                    jg.drawImage('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAADpSURBVCjPY/jPgB8y0EmBHXdWaeu7ef9rHuaY50jU3J33v/VdVqkdN1SBEZtP18T/L/7f/X/wf+O96kM3f9z9f+T/xP8+XUZsYAWGfsUfrr6L2Ob9J/X/pP+V/1P/e/+J2LbiYfEHQz+ICV1N3yen+3PZf977/9z/Q//X/rf/7M81Ob3pu1EXWIFuZvr7aSVBOx1/uf0PBEK3/46/gnZOK0l/r5sJVqCp6Xu99/2qt+v+T/9f+L8CSK77v+pt73vf65qaYAVqzPYGXvdTvmR/z/4ZHhfunP0p+3vKF6/79gZqzPQLSYoUAABKPQ+kpVV/igAAAABJRU5ErkJggg%3D%3D', x2 + 4, y2 - 8, 16, 16, 'onclick="highlightRooms(rooms[' + room1.roomid + '], rooms[' + room2.roomid + ']);"');
                } else {
                    var x1 = calcLeftPos(room1);
                    var y1 = calcMiddleYPos(room1) + room_height / 4;
                    var x2 = x1 - brokenexit_x;
                    var y2 = y1;
                    jg.drawLine(x1, y1, x2, y2);
                    if (roomexit.doorinfo.doortype >= DOOR_CLOSED) {
                        var midx = x2 + (x1 - x2) / 2; // must be positive
                        jg.drawLine(midx, y1 - door_width / 4, midx, y2 + door_width / 4);
                        if (roomexit.doorinfo.doortype == DOOR_LOCKED) {
                            jg.drawImage('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAJ/SURBVDjLbVJBaxNBGH2bpEkTmxi1NTRKTZtoQUHEWz0Igj2I4kG9eVNQhEBO7bEHc+yv8JAiHnr2B4gFqVrQRhObljQolBSTJqZJdnZmfbNr2rU68DEz33zfm/fejGHbNrxjaWlpRCk1J6WcYZxkgPGTsWJZ1mIul/vlrTe8AIVC4Qqbl5PJ5GQsFoPP5wP36PV6qNfr2OIg0L35+fm1fwDYPMLDj+l0OmOaJmq1Gjqdjr4dgUAAiUTCqSsWixvMXV5YWOjqvW+AxOSz8fHxjBAC5XJ5s91up7gO6tDrUqn0QwOTXYZSsoO+wGDB5EwkEkGlUgGb7mSz2apHajWfz9+sVqvFVCrl1P4PYExr5m16vYUjQ+c0O11DtmN/ebD95pG9UpnGzl7Y0Xz30ir8toAtLdiWG0JIvFi76piaGG7g9plVTD/5YLgMCPLg/g0YtMTwhznfApRBfsP6kAYJSKuN57Md5oXTsvHy7aEEfZMutHZfIRAahWGMsHAICMeZVsD+HmTrG8zudyhrH+HJLGyz7wEgRSh9k4nm+nvqPIb4xWuovV5k/2lMXJ9F8+s6ARqIpk6QsIQtTC+AcGTYpBqfvgBfcJTuKMi+xKfdMCZgIp6eRK8TYu2+w2oA4PwDm+5qVK218XmNLN7xxILqKfS7pGqTWekLmuVtV65STs8hA73RqJQQP5+CP3KKACamHj7FlGBDawfH00kEW0MuA8o9AmA6qMrSHqwTIAoM08hAkHkN0ES3UYfotBGdiNFu5cr2AmgJobOPET7nhxEMuU/o40soSjO7iHbbVNgnUen6pY0/AOCTbC7PuV44H0f8Cetg5g9zP5aU7loDcfwGcrKyzYdvwUUAAAAASUVORK5CYII%3D', midx + 4, y1 - 4, 16, 16, generateOnClickHandlerForKey(roomexit.doorinfo, midx + 4, y1 - 4));
                        }
                    }
                    if (roomexit.linktype == LINK_ONEWAY) {
                        jg.drawLine(x2 + 1, y2, x2 + arrowheadlength / 2, y2 - arrowheadlength / 2);
                        jg.drawLine(x2 + 1, y2, x2 + arrowheadlength / 2, y2 + arrowheadlength / 2);
                    }
                    jg.drawImage('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAADpSURBVCjPY/jPgB8y0EmBHXdWaeu7ef9rHuaY50jU3J33v/VdVqkdN1SBEZtP18T/L/7f/X/wf+O96kM3f9z9f+T/xP8+XUZsYAWGfsUfrr6L2Ob9J/X/pP+V/1P/e/+J2LbiYfEHQz+ICV1N3yen+3PZf977/9z/Q//X/rf/7M81Ob3pu1EXWIFuZvr7aSVBOx1/uf0PBEK3/46/gnZOK0l/r5sJVqCp6Xu99/2qt+v+T/9f+L8CSK77v+pt73vf65qaYAVqzPYGXvdTvmR/z/4ZHhfunP0p+3vKF6/79gZqzPQLSYoUAABKPQ+kpVV/igAAAABJRU5ErkJggg%3D%3D', x2 - 16, y2 - 8, 16, 16, 'onclick="highlightRooms(rooms[' + room1.roomid + '], rooms[' + room2.roomid + ']);"');
                }
            }
        } else if (exittype == EXIT_NORTH || exittype == EXIT_SOUTH) {
            if (room1 == room2) {
                if (exittype == EXIT_NORTH) {
                    var x1 = calcMiddleXPos(room1);
                    var y1 = calcTopPos(room1);
                    var midx = x1 + room_width / 4;
                    var midy = y1 - room_height / 4;
                    var xPoints = new Array(x1, x1, midx, midx);
                    var yPoints = new Array(y1, midy, midy, y1);
                    jg.drawPolyline(xPoints, yPoints);
                    // draw a one-way arrow
                    jg.drawLine(midx, y1 - 1, midx - arrowheadlength / 2, y1 - arrowheadlength);
                    jg.drawLine(midx, y1 - 1, midx + arrowheadlength / 2, y1 - arrowheadlength);
                } else if (exittype == EXIT_SOUTH) {
                    // todo: test this
                    var x1 = calcMiddleXPos(room1);
                    var y1 = calcBottomPos(room1);
                    var midx = x1 - room_width / 4;
                    var midy = y1 + room_height / 4;
                    var xPoints = new Array(x1, x1, midx, midx);
                    var yPoints = new Array(y1, midy, midy, y1);
                    jg.drawPolyline(xPoints, yPoints);
                    // draw a one-way arrow
                    jg.drawLine(midx, y1 + 1, midx - arrowheadlength / 2, y1 + arrowheadlength);
                    jg.drawLine(midx, y1 + 1, midx + arrowheadlength / 2, y1 + arrowheadlength);
                }
            } else if (room1x == room2x && isExitDirectlyConnected(exittype, room1, room2)) {
                // North-south exit - assume no wraparound exits (e.g. if south exit of south room connects to north exit of north room)
                // This will be captured by isExitDirectlyConnected
                
                // assume south exit for now
                var x1 = calcMiddleXPos(room1);
                var y1 = calcBottomPos(room1);
                var x2 = calcMiddleXPos(room2);
                var y2 = calcTopPos(room2);
                // change coordinates if this is a north exit
                if (room1y > room2y) {
                    x1 = calcMiddleXPos(room1);
                    y1 = calcTopPos(room1);
                    x2 = calcMiddleXPos(room2);
                    y2 = calcBottomPos(room2);
                }
                // south exit from room1 should go to room2
                
                jg.drawLine(x1, y1, x2, y2);
                if (roomexit.doorinfo.doortype >= DOOR_CLOSED) {
                    var midy = y1 + (y2 - y1) / 2;
                    var rightx = x1 + door_width / 2;
                    jg.drawLine(x1 - door_width / 2, midy, rightx, midy);
                    if (roomexit.doorinfo.doortype == DOOR_LOCKED) {
                        jg.drawImage('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAJ/SURBVDjLbVJBaxNBGH2bpEkTmxi1NTRKTZtoQUHEWz0Igj2I4kG9eVNQhEBO7bEHc+yv8JAiHnr2B4gFqVrQRhObljQolBSTJqZJdnZmfbNr2rU68DEz33zfm/fejGHbNrxjaWlpRCk1J6WcYZxkgPGTsWJZ1mIul/vlrTe8AIVC4Qqbl5PJ5GQsFoPP5wP36PV6qNfr2OIg0L35+fm1fwDYPMLDj+l0OmOaJmq1Gjqdjr4dgUAAiUTCqSsWixvMXV5YWOjqvW+AxOSz8fHxjBAC5XJ5s91up7gO6tDrUqn0QwOTXYZSsoO+wGDB5EwkEkGlUgGb7mSz2apHajWfz9+sVqvFVCrl1P4PYExr5m16vYUjQ+c0O11DtmN/ebD95pG9UpnGzl7Y0Xz30ir8toAtLdiWG0JIvFi76piaGG7g9plVTD/5YLgMCPLg/g0YtMTwhznfApRBfsP6kAYJSKuN57Md5oXTsvHy7aEEfZMutHZfIRAahWGMsHAICMeZVsD+HmTrG8zudyhrH+HJLGyz7wEgRSh9k4nm+nvqPIb4xWuovV5k/2lMXJ9F8+s6ARqIpk6QsIQtTC+AcGTYpBqfvgBfcJTuKMi+xKfdMCZgIp6eRK8TYu2+w2oA4PwDm+5qVK218XmNLN7xxILqKfS7pGqTWekLmuVtV65STs8hA73RqJQQP5+CP3KKACamHj7FlGBDawfH00kEW0MuA8o9AmA6qMrSHqwTIAoM08hAkHkN0ES3UYfotBGdiNFu5cr2AmgJobOPET7nhxEMuU/o40soSjO7iHbbVNgnUen6pY0/AOCTbC7PuV44H0f8Cetg5g9zP5aU7loDcfwGcrKyzYdvwUUAAAAASUVORK5CYII%3D', rightx + 6, midy - 8, 16, 16, generateOnClickHandlerForKey(roomexit.doorinfo, rightx + 6, midy - 8));
                    }
                }
                if (roomexit.linktype == LINK_ONEWAY) {
                    if (exittype == EXIT_NORTH) {
                        // bottom to top
                        jg.drawLine(x2, y2 + 1, x2 - arrowheadlength / 2, y2 + arrowheadlength);
                        jg.drawLine(x2, y2 + 1, x2 + arrowheadlength / 2, y2 + arrowheadlength);
                    } else {
                        // top to bottom
                        jg.drawLine(x2, y2 - 1, x2 - arrowheadlength / 2, y2 - arrowheadlength);
                        jg.drawLine(x2, y2 - 1, x2 + arrowheadlength / 2, y2 - arrowheadlength);
                    }
                }
            } else {
                if (exittype == EXIT_NORTH) {
                    var x1 = calcMiddleXPos(room1) - room_width / 4;
                    var y1 = calcTopPos(room1);
                    var x2 = x1;
                    var y2 = y1 - brokenexit_y;
                    jg.drawLine(x1, y1, x2, y2);
                    if (roomexit.doorinfo.doortype >= DOOR_CLOSED) {
                        var midy = y1 - (y1 - y2) / 2; // must be positive
                        jg.drawLine(x1 - door_width / 4, midy, x1 + door_width / 4, midy);
                        if (roomexit.doorinfo.doortype == DOOR_LOCKED) {
                            jg.drawImage('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAJ/SURBVDjLbVJBaxNBGH2bpEkTmxi1NTRKTZtoQUHEWz0Igj2I4kG9eVNQhEBO7bEHc+yv8JAiHnr2B4gFqVrQRhObljQolBSTJqZJdnZmfbNr2rU68DEz33zfm/fejGHbNrxjaWlpRCk1J6WcYZxkgPGTsWJZ1mIul/vlrTe8AIVC4Qqbl5PJ5GQsFoPP5wP36PV6qNfr2OIg0L35+fm1fwDYPMLDj+l0OmOaJmq1Gjqdjr4dgUAAiUTCqSsWixvMXV5YWOjqvW+AxOSz8fHxjBAC5XJ5s91up7gO6tDrUqn0QwOTXYZSsoO+wGDB5EwkEkGlUgGb7mSz2apHajWfz9+sVqvFVCrl1P4PYExr5m16vYUjQ+c0O11DtmN/ebD95pG9UpnGzl7Y0Xz30ir8toAtLdiWG0JIvFi76piaGG7g9plVTD/5YLgMCPLg/g0YtMTwhznfApRBfsP6kAYJSKuN57Md5oXTsvHy7aEEfZMutHZfIRAahWGMsHAICMeZVsD+HmTrG8zudyhrH+HJLGyz7wEgRSh9k4nm+nvqPIb4xWuovV5k/2lMXJ9F8+s6ARqIpk6QsIQtTC+AcGTYpBqfvgBfcJTuKMi+xKfdMCZgIp6eRK8TYu2+w2oA4PwDm+5qVK218XmNLN7xxILqKfS7pGqTWekLmuVtV65STs8hA73RqJQQP5+CP3KKACamHj7FlGBDawfH00kEW0MuA8o9AmA6qMrSHqwTIAoM08hAkHkN0ES3UYfotBGdiNFu5cr2AmgJobOPET7nhxEMuU/o40soSjO7iHbbVNgnUen6pY0/AOCTbC7PuV44H0f8Cetg5g9zP5aU7loDcfwGcrKyzYdvwUUAAAAASUVORK5CYII%3D', x2 + 10, midy - 8, 16, 16, generateOnClickHandlerForKey(roomexit.doorinfo, x2 + 10, midy - 8));
                        }
                    }
                    if (roomexit.linktype == LINK_ONEWAY) {
                        jg.drawLine(x2, y2 + 1, x2 - arrowheadlength / 2, y2 + arrowheadlength / 2);
                        jg.drawLine(x2, y2 + 1, x2 + arrowheadlength / 2, y2 + arrowheadlength / 2);
                    }
                    jg.drawImage('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAADpSURBVCjPY/jPgB8y0EmBHXdWaeu7ef9rHuaY50jU3J33v/VdVqkdN1SBEZtP18T/L/7f/X/wf+O96kM3f9z9f+T/xP8+XUZsYAWGfsUfrr6L2Ob9J/X/pP+V/1P/e/+J2LbiYfEHQz+ICV1N3yen+3PZf977/9z/Q//X/rf/7M81Ob3pu1EXWIFuZvr7aSVBOx1/uf0PBEK3/46/gnZOK0l/r5sJVqCp6Xu99/2qt+v+T/9f+L8CSK77v+pt73vf65qaYAVqzPYGXvdTvmR/z/4ZHhfunP0p+3vKF6/79gZqzPQLSYoUAABKPQ+kpVV/igAAAABJRU5ErkJggg%3D%3D', x1 - 8, y2 - 16, 16, 16, 'onclick="highlightRooms(rooms[' + room1.roomid + '], rooms[' + room2.roomid + ']);"');
                } else {
                    var x1 = calcMiddleXPos(room1) + room_width / 4;
                    var y1 = calcBottomPos(room1);
                    var x2 = x1;
                    var y2 = y1 + brokenexit_y;
                    jg.drawLine(x1, y1, x2, y2);
                    if (roomexit.doorinfo.doortype >= DOOR_CLOSED) {
                        var midy = y1 + (y2 - y1) / 2; // must be positive
                        jg.drawLine(x1 - door_width / 4, midy, x1 + door_width / 4, midy);
                        if (roomexit.doorinfo.doortype == DOOR_LOCKED) {
                            jg.drawImage('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAJ/SURBVDjLbVJBaxNBGH2bpEkTmxi1NTRKTZtoQUHEWz0Igj2I4kG9eVNQhEBO7bEHc+yv8JAiHnr2B4gFqVrQRhObljQolBSTJqZJdnZmfbNr2rU68DEz33zfm/fejGHbNrxjaWlpRCk1J6WcYZxkgPGTsWJZ1mIul/vlrTe8AIVC4Qqbl5PJ5GQsFoPP5wP36PV6qNfr2OIg0L35+fm1fwDYPMLDj+l0OmOaJmq1Gjqdjr4dgUAAiUTCqSsWixvMXV5YWOjqvW+AxOSz8fHxjBAC5XJ5s91up7gO6tDrUqn0QwOTXYZSsoO+wGDB5EwkEkGlUgGb7mSz2apHajWfz9+sVqvFVCrl1P4PYExr5m16vYUjQ+c0O11DtmN/ebD95pG9UpnGzl7Y0Xz30ir8toAtLdiWG0JIvFi76piaGG7g9plVTD/5YLgMCPLg/g0YtMTwhznfApRBfsP6kAYJSKuN57Md5oXTsvHy7aEEfZMutHZfIRAahWGMsHAICMeZVsD+HmTrG8zudyhrH+HJLGyz7wEgRSh9k4nm+nvqPIb4xWuovV5k/2lMXJ9F8+s6ARqIpk6QsIQtTC+AcGTYpBqfvgBfcJTuKMi+xKfdMCZgIp6eRK8TYu2+w2oA4PwDm+5qVK218XmNLN7xxILqKfS7pGqTWekLmuVtV65STs8hA73RqJQQP5+CP3KKACamHj7FlGBDawfH00kEW0MuA8o9AmA6qMrSHqwTIAoM08hAkHkN0ES3UYfotBGdiNFu5cr2AmgJobOPET7nhxEMuU/o40soSjO7iHbbVNgnUen6pY0/AOCTbC7PuV44H0f8Cetg5g9zP5aU7loDcfwGcrKyzYdvwUUAAAAASUVORK5CYII%3D', x2 + 10, midy - 8, 16, 16, generateOnClickHandlerForKey(roomexit.doorinfo, x2 + 10, midy - 8));
                        }
                    }
                    if (roomexit.linktype == LINK_ONEWAY) {
                        jg.drawLine(x2, y2 - 1, x2 - arrowheadlength / 2, y2 - arrowheadlength / 2);
                        jg.drawLine(x2, y2 - 1, x2 + arrowheadlength / 2, y2 - arrowheadlength / 2);
                    }
                    jg.drawImage('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAADpSURBVCjPY/jPgB8y0EmBHXdWaeu7ef9rHuaY50jU3J33v/VdVqkdN1SBEZtP18T/L/7f/X/wf+O96kM3f9z9f+T/xP8+XUZsYAWGfsUfrr6L2Ob9J/X/pP+V/1P/e/+J2LbiYfEHQz+ICV1N3yen+3PZf977/9z/Q//X/rf/7M81Ob3pu1EXWIFuZvr7aSVBOx1/uf0PBEK3/46/gnZOK0l/r5sJVqCp6Xu99/2qt+v+T/9f+L8CSK77v+pt73vf65qaYAVqzPYGXvdTvmR/z/4ZHhfunP0p+3vKF6/79gZqzPQLSYoUAABKPQ+kpVV/igAAAABJRU5ErkJggg%3D%3D', x1 - 8, y2, 16, 16, 'onclick="highlightRooms(rooms[' + room1.roomid + '], rooms[' + room2.roomid + ']);"');
                }
            }
        } else if (exittype == EXIT_UP || exittype == EXIT_DOWN) {
            var rise = room1y - room2y;
            if (room1 == room2) {
                // The exit loops back on itself.
                if (exittype == EXIT_DOWN) {
                    var x1 = calcLeftPos(room1);
                    var y1 = calcBottomPos(room1);
                    var midy1 = y1 + roomgap_y / 2;
                    
                    var midx = x1 - room_width / 5;
                    var midy2 = y1 - room_height / 4;
                    var xPoints = new Array(x1, midx, midx, x1);
                    var yPoints = new Array(y1, midy1, midy2, midy2);
                    jg.drawPolyline(xPoints, yPoints);
                    // draw a one-way arrow
                    jg.drawLine(x1 - 1, midy2, x1 - arrowheadlength, midy2 - arrowheadlength / 2);
                    jg.drawLine(x1 - 1, midy2, x1 - arrowheadlength, midy2 + arrowheadlength / 2);
                } else if (exittype == EXIT_UP) {
                    var x1 = calcRightPos(room1);
                    var y1 = calcTopPos(room1);
                    var midy1 = y1 - roomgap_y / 2;
                    
                    var midx = x1 + room_width / 5;
                    var midy2 = y1 + room_height / 4;
                    var xPoints = new Array(x1, midx, midx, x1);
                    var yPoints = new Array(y1, midy1, midy2, midy2);
                    jg.drawPolyline(xPoints, yPoints);
                    // draw a one-way arrow
                    jg.drawLine(x1 + 1, midy2, x1 + arrowheadlength, midy2 - arrowheadlength / 2);
                    jg.drawLine(x1 + 1, midy2, x1 + arrowheadlength, midy2 + arrowheadlength / 2);
                }
            } else {
                if (roomexit.forceBrokenExit || rise == 0 || !isExitDirectlyConnected(exittype, room1, room2)) {
                    if (exittype == EXIT_UP) {
                        var x1 = calcRightPos(room1);
                        var y1 = calcTopPos(room1);
                        var x2 = x1 + roomgap_x / 3;
                        var y2 = y1 - roomgap_y / 3;
                        jg.drawLine(x1, y1, x2, y2);
                        if (roomexit.doorinfo.doortype >= DOOR_CLOSED) {
                            // todo: use proper door_width lengths
                            jg.drawLine(x1, y2, x2, y1);
                            if (roomexit.doorinfo.doortype == DOOR_LOCKED) {
                                jg.drawImage('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAJ/SURBVDjLbVJBaxNBGH2bpEkTmxi1NTRKTZtoQUHEWz0Igj2I4kG9eVNQhEBO7bEHc+yv8JAiHnr2B4gFqVrQRhObljQolBSTJqZJdnZmfbNr2rU68DEz33zfm/fejGHbNrxjaWlpRCk1J6WcYZxkgPGTsWJZ1mIul/vlrTe8AIVC4Qqbl5PJ5GQsFoPP5wP36PV6qNfr2OIg0L35+fm1fwDYPMLDj+l0OmOaJmq1Gjqdjr4dgUAAiUTCqSsWixvMXV5YWOjqvW+AxOSz8fHxjBAC5XJ5s91up7gO6tDrUqn0QwOTXYZSsoO+wGDB5EwkEkGlUgGb7mSz2apHajWfz9+sVqvFVCrl1P4PYExr5m16vYUjQ+c0O11DtmN/ebD95pG9UpnGzl7Y0Xz30ir8toAtLdiWG0JIvFi76piaGG7g9plVTD/5YLgMCPLg/g0YtMTwhznfApRBfsP6kAYJSKuN57Md5oXTsvHy7aEEfZMutHZfIRAahWGMsHAICMeZVsD+HmTrG8zudyhrH+HJLGyz7wEgRSh9k4nm+nvqPIb4xWuovV5k/2lMXJ9F8+s6ARqIpk6QsIQtTC+AcGTYpBqfvgBfcJTuKMi+xKfdMCZgIp6eRK8TYu2+w2oA4PwDm+5qVK218XmNLN7xxILqKfS7pGqTWekLmuVtV65STs8hA73RqJQQP5+CP3KKACamHj7FlGBDawfH00kEW0MuA8o9AmA6qMrSHqwTIAoM08hAkHkN0ES3UYfotBGdiNFu5cr2AmgJobOPET7nhxEMuU/o40soSjO7iHbbVNgnUen6pY0/AOCTbC7PuV44H0f8Cetg5g9zP5aU7loDcfwGcrKyzYdvwUUAAAAASUVORK5CYII%3D', x2 + 2, y2 + 8, 16, 16, generateOnClickHandlerForKey(roomexit.doorinfo, x2 + 2, y2 + 8));
                            }
                        }
                        if (roomexit.linktype == LINK_ONEWAY) {
                            jg.drawLine(x2 - arrowheadlength, y2, x2, y2);
                            jg.drawLine(x2, y2 + arrowheadlength, x2, y2);
                        }
                        jg.drawImage('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAADpSURBVCjPY/jPgB8y0EmBHXdWaeu7ef9rHuaY50jU3J33v/VdVqkdN1SBEZtP18T/L/7f/X/wf+O96kM3f9z9f+T/xP8+XUZsYAWGfsUfrr6L2Ob9J/X/pP+V/1P/e/+J2LbiYfEHQz+ICV1N3yen+3PZf977/9z/Q//X/rf/7M81Ob3pu1EXWIFuZvr7aSVBOx1/uf0PBEK3/46/gnZOK0l/r5sJVqCp6Xu99/2qt+v+T/9f+L8CSK77v+pt73vf65qaYAVqzPYGXvdTvmR/z/4ZHhfunP0p+3vKF6/79gZqzPQLSYoUAABKPQ+kpVV/igAAAABJRU5ErkJggg%3D%3D', x2, y2 - 12, 16, 16, 'onclick="highlightRooms(rooms[' + room1.roomid + '], rooms[' + room2.roomid + ']);"');
                    } else {
                        var x1 = calcLeftPos(room1);
                        var y1 = calcBottomPos(room1);
                        var x2 = x1 - roomgap_x / 3;
                        var y2 = y1 + roomgap_y / 3;
                        jg.drawLine(x1, y1, x2, y2);
                        if (roomexit.doorinfo.doortype >= DOOR_CLOSED) {
                            // todo: use proper door_width lengths
                            jg.drawLine(x1, y2, x2, y1);
                            if (roomexit.doorinfo.doortype == DOOR_LOCKED) {
                                jg.drawImage('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAJ/SURBVDjLbVJBaxNBGH2bpEkTmxi1NTRKTZtoQUHEWz0Igj2I4kG9eVNQhEBO7bEHc+yv8JAiHnr2B4gFqVrQRhObljQolBSTJqZJdnZmfbNr2rU68DEz33zfm/fejGHbNrxjaWlpRCk1J6WcYZxkgPGTsWJZ1mIul/vlrTe8AIVC4Qqbl5PJ5GQsFoPP5wP36PV6qNfr2OIg0L35+fm1fwDYPMLDj+l0OmOaJmq1Gjqdjr4dgUAAiUTCqSsWixvMXV5YWOjqvW+AxOSz8fHxjBAC5XJ5s91up7gO6tDrUqn0QwOTXYZSsoO+wGDB5EwkEkGlUgGb7mSz2apHajWfz9+sVqvFVCrl1P4PYExr5m16vYUjQ+c0O11DtmN/ebD95pG9UpnGzl7Y0Xz30ir8toAtLdiWG0JIvFi76piaGG7g9plVTD/5YLgMCPLg/g0YtMTwhznfApRBfsP6kAYJSKuN57Md5oXTsvHy7aEEfZMutHZfIRAahWGMsHAICMeZVsD+HmTrG8zudyhrH+HJLGyz7wEgRSh9k4nm+nvqPIb4xWuovV5k/2lMXJ9F8+s6ARqIpk6QsIQtTC+AcGTYpBqfvgBfcJTuKMi+xKfdMCZgIp6eRK8TYu2+w2oA4PwDm+5qVK218XmNLN7xxILqKfS7pGqTWekLmuVtV65STs8hA73RqJQQP5+CP3KKACamHj7FlGBDawfH00kEW0MuA8o9AmA6qMrSHqwTIAoM08hAkHkN0ES3UYfotBGdiNFu5cr2AmgJobOPET7nhxEMuU/o40soSjO7iHbbVNgnUen6pY0/AOCTbC7PuV44H0f8Cetg5g9zP5aU7loDcfwGcrKyzYdvwUUAAAAASUVORK5CYII%3D', x1, y2, 16, 16, generateOnClickHandlerForKey(roomexit.doorinfo, x1, y2));
                            }
                        }
                        if (roomexit.linktype == LINK_ONEWAY) {
                            jg.drawLine(x2 + arrowheadlength, y2, x2, y2);
                            jg.drawLine(x2, y2 - arrowheadlength, x2, y2);
                        }
                        jg.drawImage('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAADpSURBVCjPY/jPgB8y0EmBHXdWaeu7ef9rHuaY50jU3J33v/VdVqkdN1SBEZtP18T/L/7f/X/wf+O96kM3f9z9f+T/xP8+XUZsYAWGfsUfrr6L2Ob9J/X/pP+V/1P/e/+J2LbiYfEHQz+ICV1N3yen+3PZf977/9z/Q//X/rf/7M81Ob3pu1EXWIFuZvr7aSVBOx1/uf0PBEK3/46/gnZOK0l/r5sJVqCp6Xu99/2qt+v+T/9f+L8CSK77v+pt73vf65qaYAVqzPYGXvdTvmR/z/4ZHhfunP0p+3vKF6/79gZqzPQLSYoUAABKPQ+kpVV/igAAAABJRU5ErkJggg%3D%3D', x2 - 12, y2, 16, 16, 'onclick="highlightRooms(rooms[' + room1.roomid + '], rooms[' + room2.roomid + ']);"');
                    }
                } else {
                    // Up-down exit (sort by x-axis)
                    if (room1x > room2x) {
                        // todo: this is really messed up, but it works
                        // should really clean it up
                        var swap = room1;
                        room1 = room2;
                        room2 = swap;
                        // if (exittype == EXIT_UP) {
                        //     exittype = EXIT_DOWN;
                        // } else {
                        //     exittype = EXIT_UP;
                        // }
                    }
                    room1x = room1.xpos;
                    room2x = room2.xpos;
                    room1y = room1.ypos;
                    room2y = room2.ypos;
                    if (room1y > room2y) {
                        // going up from room1
                        var x1 = calcRightPos(room1);
                        var y1 = calcTopPos(room1);
                        var x2 = calcLeftPos(room2);
                        var y2 = calcBottomPos(room2);
                    
                        jg.drawLine(x1, y1, x2, y2);
                        // todo/fixme: this isn't working yet
                        if (roomexit.doorinfo.doortype >= DOOR_CLOSED) {
                            var midy = y1 + (y2 - y1) / 2;
                            var midx = x1 + (x2 - x1) / 2;
                            jg.drawLine(midx - door_width / 4, midy - door_width / 4, midx + door_width / 4, midy + door_width / 4);
                            if (roomexit.doorinfo.doortype == DOOR_LOCKED) {
                                jg.drawImage('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAJ/SURBVDjLbVJBaxNBGH2bpEkTmxi1NTRKTZtoQUHEWz0Igj2I4kG9eVNQhEBO7bEHc+yv8JAiHnr2B4gFqVrQRhObljQolBSTJqZJdnZmfbNr2rU68DEz33zfm/fejGHbNrxjaWlpRCk1J6WcYZxkgPGTsWJZ1mIul/vlrTe8AIVC4Qqbl5PJ5GQsFoPP5wP36PV6qNfr2OIg0L35+fm1fwDYPMLDj+l0OmOaJmq1Gjqdjr4dgUAAiUTCqSsWixvMXV5YWOjqvW+AxOSz8fHxjBAC5XJ5s91up7gO6tDrUqn0QwOTXYZSsoO+wGDB5EwkEkGlUgGb7mSz2apHajWfz9+sVqvFVCrl1P4PYExr5m16vYUjQ+c0O11DtmN/ebD95pG9UpnGzl7Y0Xz30ir8toAtLdiWG0JIvFi76piaGG7g9plVTD/5YLgMCPLg/g0YtMTwhznfApRBfsP6kAYJSKuN57Md5oXTsvHy7aEEfZMutHZfIRAahWGMsHAICMeZVsD+HmTrG8zudyhrH+HJLGyz7wEgRSh9k4nm+nvqPIb4xWuovV5k/2lMXJ9F8+s6ARqIpk6QsIQtTC+AcGTYpBqfvgBfcJTuKMi+xKfdMCZgIp6eRK8TYu2+w2oA4PwDm+5qVK218XmNLN7xxILqKfS7pGqTWekLmuVtV65STs8hA73RqJQQP5+CP3KKACamHj7FlGBDawfH00kEW0MuA8o9AmA6qMrSHqwTIAoM08hAkHkN0ES3UYfotBGdiNFu5cr2AmgJobOPET7nhxEMuU/o40soSjO7iHbbVNgnUen6pY0/AOCTbC7PuV44H0f8Cetg5g9zP5aU7loDcfwGcrKyzYdvwUUAAAAASUVORK5CYII%3D', midx + door_width / 4 + 2, midy + door_width / 4, 16, 16, generateOnClickHandlerForKey(roomexit.doorinfo, midx + door_width / 4 + 2, midy + door_width / 4));
                            }
                        }
                        if (roomexit.linktype == LINK_ONEWAY) {
                            if (exittype == EXIT_UP) {
                                jg.drawLine(x2 - arrowheadlength, y2, x2, y2);
                                jg.drawLine(x2, y2 + arrowheadlength, x2, y2);
                            } else {
                                // note: not impossible to be a down exit?!
                                jg.drawLine(x1, y1, x1 + arrowheadlength, y1);
                                jg.drawLine(x1, y1, x1, y1 - arrowheadlength);
                            }
                        
                        }
                    } else {
                        // going down from room1
                        var x1 = calcRightPos(room1);
                        var y1 = calcBottomPos(room1);
                        var x2 = calcLeftPos(room2);
                        var y2 = calcTopPos(room2);
                    
                        jg.drawLine(x1, y1, x2, y2);
                    
                        if (roomexit.doorinfo.doortype >= DOOR_CLOSED) {
                            var midy = y1 + (y2 - y1) / 2;
                            var midx = x1 + (x2 - x1) / 2;
                            jg.drawLine(midx - door_width / 4, midy + door_width / 4, midx + door_width / 4, midy - door_width / 4);
                            if (roomexit.doorinfo.doortype == DOOR_LOCKED) {
                                jg.drawImage('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAJ/SURBVDjLbVJBaxNBGH2bpEkTmxi1NTRKTZtoQUHEWz0Igj2I4kG9eVNQhEBO7bEHc+yv8JAiHnr2B4gFqVrQRhObljQolBSTJqZJdnZmfbNr2rU68DEz33zfm/fejGHbNrxjaWlpRCk1J6WcYZxkgPGTsWJZ1mIul/vlrTe8AIVC4Qqbl5PJ5GQsFoPP5wP36PV6qNfr2OIg0L35+fm1fwDYPMLDj+l0OmOaJmq1Gjqdjr4dgUAAiUTCqSsWixvMXV5YWOjqvW+AxOSz8fHxjBAC5XJ5s91up7gO6tDrUqn0QwOTXYZSsoO+wGDB5EwkEkGlUgGb7mSz2apHajWfz9+sVqvFVCrl1P4PYExr5m16vYUjQ+c0O11DtmN/ebD95pG9UpnGzl7Y0Xz30ir8toAtLdiWG0JIvFi76piaGG7g9plVTD/5YLgMCPLg/g0YtMTwhznfApRBfsP6kAYJSKuN57Md5oXTsvHy7aEEfZMutHZfIRAahWGMsHAICMeZVsD+HmTrG8zudyhrH+HJLGyz7wEgRSh9k4nm+nvqPIb4xWuovV5k/2lMXJ9F8+s6ARqIpk6QsIQtTC+AcGTYpBqfvgBfcJTuKMi+xKfdMCZgIp6eRK8TYu2+w2oA4PwDm+5qVK218XmNLN7xxILqKfS7pGqTWekLmuVtV65STs8hA73RqJQQP5+CP3KKACamHj7FlGBDawfH00kEW0MuA8o9AmA6qMrSHqwTIAoM08hAkHkN0ES3UYfotBGdiNFu5cr2AmgJobOPET7nhxEMuU/o40soSjO7iHbbVNgnUen6pY0/AOCTbC7PuV44H0f8Cetg5g9zP5aU7loDcfwGcrKyzYdvwUUAAAAASUVORK5CYII%3D', midx + door_width / 2, midy - door_width / 2, 16, 16, generateOnClickHandlerForKey(roomexit.doorinfo, midx + door_width / 2, midy - door_width / 2));
                            }
                        }
                        if (roomexit.linktype == LINK_ONEWAY) {
                            if (exittype == EXIT_DOWN) {
                                jg.drawLine(x2 - arrowheadlength, y2, x2, y2);
                                jg.drawLine(x2, y2 - arrowheadlength, x2, y2);
                            } else {
                                // note: impossible to be an up exit?!
                                jg.drawLine(x1, y1, x1 + arrowheadlength, y1);
                                jg.drawLine(x1, y1, x1, y1 + arrowheadlength);
                            }
                        }
                    }
                }
            }
        }
    }
    jg.setColor("black");
}

function generateOnClickHandlerForKey(doorinfo, imgx, imgy) {
    // doorname, doortype, keyname, keydesc, keyroom
    var handler = "Tip(&quot;";
    var roomProvided = doorinfo.keyroom != null;
    if (doorinfo.doorname != "" && doorinfo.keyname != "") {
        handler += "<i>" + doorinfo.doorname + "</i> can be opened with <b>" + doorinfo.keyname + "</b>";
        if (roomProvided) {
            handler += "<br>found in \\&quot;" + doorinfo.keyroom.roomname + "\\&quot;";
        }
        handler += doorinfo.keydesc;
        if (roomProvided) {
            handler += "<p>Click to highlight key location.</p>";
        }
        handler += "&quot;, ABOVE, true, OFFSETX, -17, PADDING, 8, WIDTH, -400);";
    } else {
        handler += "No information is available for this locked door.<br>Try picking the lock or quaffing a passdoor potion. :)&quot;, ABOVE, true, OFFSETX, -17, PADDING, 8);";
    }
    var result = 'onmouseover=\"' + handler + '\" onmouseout=\"UnTip();\"';
    if (roomProvided) {
        result += ' onclick=\"highlightKeyRoom(rooms[' + doorinfo.keyroom.roomid + '], ' + imgx + ', ' + imgy + ');\"';
    }
    return result;
}

function calcLeftPos(room) {
    return room.xpos * room_width + (room.xpos - 1) * roomgap_x
}
function calcTopPos(room) {
    return room.ypos * room_height + (room.ypos - 1) * roomgap_y
}
function calcRightPos(room) {
    return calcLeftPos(room) + room_width
}
function calcBottomPos(room) {
    return calcTopPos(room) + room_height
}
function calcMiddleXPos(room) {
    return calcLeftPos(room) + (room_width/2)
}
function calcMiddleYPos(room) {
    return calcTopPos(room) + (room_height/2)
}
function updateMap() {
    jg.paint();
}

function submitSearchRoomsRequest() {
    searchRooms(document.getElementById('roomnamebox').value);
}

function searchRooms(roomname) {
    jg3.clear();
    setSearchResultsMessage("");
    if (roomname != null && roomname != '') {
        var results = 0;
        var re = new RegExp(roomname, "i");
        for (var i = 1; i < rooms.length; i++) {
            if (rooms[i].roomname.match(re)) {
                drawRoom(rooms[i], jg3, "cyan", "lightcyan");
                results++;
            }
        }
        if (results == 0) {
            setSearchResultsMessage("No matching rooms found.");
        } else {
            var message = results + " room" + (results == 1 ? "" : "s") + " highlighted.";
            setSearchResultsMessage(message);
        }
        jg3.paint();
    }
}

function setSearchResultsMessage(message) {
    document.getElementById("searchboxresults").innerHTML = message;
}

function highlightRooms(room, room2) {
    jg2.clear();
    link = room.roomid + '-' + room2.roomid;
    reversedLink = room2.roomid + '-' + room.roomid;
    if (highlightedRooms != link && highlightedRooms != reversedLink) {
        highlightRoom(room);
        highlightRoom(room2);
        highlightedRooms = link;
        // Now show the link between the two rooms
        jg2.setColor("orange");
        var mid1x = calcRightPos(room);
        var mid1y = calcBottomPos(room);
        var mid2x = calcRightPos(room2);
        var mid2y = calcBottomPos(room2);
        jg2.fillOval(mid1x - 16, mid1y - 16, 16, 16);
        jg2.fillOval(mid2x - 16, mid2y - 16, 16, 16);
        jg2.setStroke(2);
        jg2.drawLine(mid1x - 8, mid1y - 8, mid2x - 8, mid2y - 8);
        jg2.paint();
    } else {
        highlightedRooms = '';
    }
}

function highlightRoom(room) {
    drawRoom(room, jg2, "yellow", "lightyellow");
}

function highlightKeyRoom(room, imgx, imgy) {
    jg4.clear();
    if (highlightedKeyRoom != room.roomid) {
        drawRoom(room, jg4, "purple", "#ffd6fe");
        highlightedKeyRoom = room.roomid;
        // draw line between lock and contained location
        jg4.setColor("#4B0082");
        var mid1x = calcRightPos(room);
        var mid1y = calcBottomPos(room);
        var mid2x = imgx + 16 + 11; // hack x pos to make line vertical for a room on the same x axis
        var mid2y = imgy + 16 + 8;
        jg4.fillOval(mid1x - 16, mid1y - 16, 16, 16);
        jg4.fillOval(mid2x - 12, mid2y - 12, 12, 12);
        jg4.setStroke(2);
        jg4.drawLine(mid1x - 8, mid1y - 8, mid2x - 6, mid2y - 6);
        jg4.paint();
    } else {
        highlightedKeyRoom = '';
    }
}

// first disconnected exit could be obscured -- re-render whenever the room is rendered
function rerenderFirstDisconnectedExit(room, jg) {
    // re-render only the first exit
    var roomExits = room.exitsArray;
    for (var i = 0; i < roomExits.length; i++) {
        if (roomExits[i].linktype == LINK_DISCONNECTED) {
            drawExit(roomExits[i], jg);
            break;
        }
    }
}

// Assumes init() has already been called.
function drawMap() {
    // Initialize the fill grid with false -> sets fill_grid[x][y] = false
    for (var i = 1; i <= gridmaxx; i++) {
        fill_grid[i] = new Array();
        for (var j = 1; j <= gridmaxy; j++) {
            fill_grid[i][j] = false;
        }
    }
    
    // For each of the rooms, mark its corresponding cell as occupied or not.
    for (var i = 1; i < rooms.length; i++) {
        var room = rooms[i];
        // Only mark room as occupied if it is placed on the map!
        if (room.xpos > 0 && room.ypos > 0) {
            fill_grid[room.xpos][room.ypos] = true;
        }
    }
    
    // Draw all of the exits before rooms.
    for (var i = 1; i < rooms.length; i++) {
        exits = rooms[i].exitsArray;
        for (var j = 0; j < exits.length; j++) {
            drawExit(exits[j], jg);
        }
    }
    
    // Finally render the rooms (and any obscured exits).
    for (var i = 1; i < rooms.length; i++) {
        var room = rooms[i];
        drawRoom(room, jg);
    }
    
    // Draw all the labels
    for (var i = 1; i < labels.length; i++) {
        var label = labels[i];
        drawLabel(label, jg);
    }
    
    // Pad some space on the bottom and the right.
    var xdelta = 0;
    var ydelta = 0;
    var maxx = (gridmaxx + xdelta + 1) * room_width + (gridmaxx + xdelta) * roomgap_x + CONTAINER_PAD_RIGHT;
    var maxy = (gridmaxy + ydelta + 1) * room_height + (gridmaxy + ydelta) * roomgap_y + CONTAINER_PAD_DOWN;
    jg.setColor("white");
    jg.drawRect(maxx, maxy, 1, 1);
    
    updateMap();
    document.getElementById("top-strip").style.width = (maxx + CONTAINER_PAD_LEFT + CONTAINER_PAD_RIGHT) + "px";
}
drawMap();

</script>
        <script type="text/javascript" src="wz_tooltip/wz_tooltip.js"></script> 
        <script type="text/javascript" src="wz_tooltip/tip_centerwindow.js"></script>
        <script type="text/javascript" src="wz_tooltip/tip_balloon.js"></script>
        <script type="text/javascript" src="jquery-1.3.2.min.js"></script>
        <script>
        $(document).ready(function(){
            $("#moreinfo").click(function () {
                var topHeight = $("#top-strip").height();
                var infoOffset = $("#areainfo").offset().top;
                var mapTop = $("#map-container").offset().top;
                if ($("#areainfo").is(":hidden")) {
                    $("#areainfo").width(($("#top-strip").width() - 120) + "px");
                } else {
                }
                $("#areainfo").slideToggle("slow");
            });
            // Set the top strip to be min 900px.
            if ($("#top-strip").width() < 900) {
                $("#top-strip").width("900px");
            }
			// update the room count
			$("#room_count_span").html(rooms.length - 1);
        });
          </script>

	<script type="text/javascript">

	  var _gaq = _gaq || [];
	  _gaq.push(['_setAccount', 'UA-27355433-1']);
	  _gaq.push(['_setDomainName', '.gaardian.com']);
	  _gaq.push(['_trackPageview']);

	  (function() {
	    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
	    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
	    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	  })();

	</script>
	<script type="text/javascript">var a=new Date,b=a.getUTCHours();if(0==a.getUTCMonth()&&2012==a.getUTCFullYear()&&((18==a.getUTCDate()&&13<=b)||(19==a.getUTCDate()&&0>=b)))window.location="http://sopastrike.com/strike";</script>
	
    </body>
</html>
